import {
  HttpException,
  Injectable,
  InternalServerErrorException,
  Logger,
  NotFoundException,
  OnModuleInit,
} from '@nestjs/common';
import { SchedulerRegistry } from '@nestjs/schedule';
import { CronJob } from 'cron';
import { eq } from 'drizzle-orm';
import { addDays, format, startOfWeek } from 'date-fns';
import { zhCN } from 'date-fns/locale';
import { DrizzleService } from '../drizzle/drizzle.service';
import { dutiesTable, dutiesUsers } from '../../drizzle/schema';
import { FeishuService } from '../feishu/feishu.service';
import { convertToCron } from '../utils';

@Injectable()
export class TasksService implements OnModuleInit {
  private readonly logger = new Logger(TasksService.name);
  private taskCallbacks = new Map<number, () => void>();

  constructor(
    private readonly drizzle: DrizzleService,
    private readonly feishu: FeishuService,
    private readonly scheduler: SchedulerRegistry,
  ) {}

  /**
   * Ëé∑ÂèñÂÄºÁè≠ËÆ°ÂàíÂΩìÂâçÂíå‰∏ã‰∏ÄÂë®Ë¥üË¥£‰∫∫‰ø°ÊÅØ
   * @param planId
   */
  async getDutyUserInfo(planId: number) {
    // ÊâßË°åËÆ°ÂàíÊü•ËØ¢
    const plans = await this.drizzle.db
      .select()
      .from(dutiesTable)
      .where(eq(dutiesTable.id, planId));

    const plan = plans[0];
    if (!plan) {
      throw new NotFoundException(`Êú™ÊâæÂà∞ID‰∏∫ ${planId} ÁöÑÂÄºÁè≠ËÆ°Âàí`);
    }

    // ÊâßË°åÁî®Êà∑Êü•ËØ¢
    const users = await this.drizzle.db
      .select({
        id: dutiesUsers.userId,
      })
      .from(dutiesUsers)
      .where(eq(dutiesUsers.dutyId, planId))
      .orderBy(dutiesUsers.orderIndex);

    if (users.length === 0) {
      throw new InternalServerErrorException(
        `ÂÄºÁè≠ËÆ°Âàí ${planId} Ê≤°ÊúâÂÖ≥ËÅîÁöÑÁî®Êà∑`,
      );
    }

    return {
      currentUserId: users[plan.personIndex].id,
      nextUserId: users[(plan.personIndex + 1) % users.length].id,
      index: plan.personIndex,
    };
  }

  /**
   * ÂàõÂª∫ÂõûË∞ÉÂáΩÊï∞Â§ÑÁêÜÂô®
   */
  private createCallbackHandler(
    plan: typeof dutiesTable.$inferSelect,
  ): () => void {
    switch (plan.templateId) {
      case '0':
        return () => {
          void (async () => {
            try {
              const { currentUserId } = await this.getDutyUserInfo(plan.id);

              await this.feishu.sendMessage({
                receiveId: plan.receiveId,
                msgType: 'text',
                content: JSON.stringify({
                  text: `üîî Êú¨Âë®Âë®‰ºöÂ∑≤ÁªìÊùüÔºå‰∏ãÂë®Âë®‰ºö‰∏ªÊåÅ‰∫∫ÊòØ <at user_id="${currentUserId}"></at>ÔºåËØ∑ÂÖ≥Ê≥®‰ºöËÆÆÂÆ§È¢ÑÂÆöÊÉÖÂÜµ„ÄÇ`,
                }),
              });

              await this.drizzle.db
                .update(dutiesTable)
                .set({
                  lastRunTime: format(new Date(), 'yyyy-MM-dd HH:mm:ss'),
                })
                .where(eq(dutiesTable.id, plan.id));
            } catch (error) {
              this.logger.error('ÊâßË°å‰ªªÂä°Â§±Ë¥•:', error);
            }
          })();
        };

      case 'AAq4NEqabytNS':
        return () => {
          void (async () => {
            try {
              const { currentUserId, nextUserId } = await this.getDutyUserInfo(
                plan.id,
              );

              const today = new Date();
              const start = startOfWeek(today, { weekStartsOn: 1 });
              const thursday = addDays(start, 3);
              const formattedDate = format(thursday, 'yyyyÂπ¥MÊúàdÊó• (EEEE)', {
                locale: zhCN,
              });

              await this.feishu.sendMessage({
                receiveId: plan.receiveId,
                msgType: 'interactive',
                content: JSON.stringify({
                  type: 'template',
                  data: {
                    template_id: 'AAq4NEqabytNS',
                    template_variable: {
                      host: currentUserId,
                      nextHost: nextUserId,
                      date: formattedDate,
                      at: `<at id=${currentUserId}></at>`,
                      next: `<at id=${nextUserId}></at>`,
                    },
                  },
                }),
              });

              await this.drizzle.db
                .update(dutiesTable)
                .set({
                  lastRunTime: format(new Date(), 'yyyy-MM-dd HH:mm:ss'),
                })
                .where(eq(dutiesTable.id, plan.id));
            } catch (error) {
              this.logger.error('ÊâßË°å‰ªªÂä°Â§±Ë¥•:', error);
            }
          })();
        };

      case 'AAqdruv7QvD1U':
        return () => {
          void (async () => {
            try {
              const { currentUserId } = await this.getDutyUserInfo(plan.id);

              const tomorrow = addDays(new Date(), 1);
              const formattedDate = format(tomorrow, 'yyyy-MM-dd');
              const dayOfWeek = format(tomorrow, 'EEEE', { locale: zhCN });

              await this.feishu.sendMessage({
                receiveId: plan.receiveId,
                msgType: 'interactive',
                content: JSON.stringify({
                  type: 'template',
                  data: {
                    template_id: 'AAqdruv7QvD1U',
                    template_variable: {
                      date: `ÂèëÁâàÊó∂Èó¥Ôºö${formattedDate}Ôºà${dayOfWeek}Ôºâ`,
                      manager: `<at id=${currentUserId}></at>`,
                      branch: `release/${formattedDate.split('-').join('')}`,
                    },
                  },
                }),
              });

              await this.drizzle.db
                .update(dutiesTable)
                .set({
                  lastRunTime: format(new Date(), 'yyyy-MM-dd HH:mm:ss'),
                })
                .where(eq(dutiesTable.id, plan.id));
            } catch (error) {
              this.logger.error('ÊâßË°å‰ªªÂä°Â§±Ë¥•:', error);
            }
          })();
        };

      case 'AAqdr8y0VxPDi':
        return () => {
          void (async () => {
            try {
              const { currentUserId } = await this.getDutyUserInfo(plan.id);

              const formattedDate = format(new Date(), 'yyyy-MM-dd');

              await this.feishu.sendMessage({
                receiveId: plan.receiveId,
                msgType: 'interactive',
                content: JSON.stringify({
                  type: 'template',
                  data: {
                    template_id: 'AAqdr8y0VxPDi',
                    template_variable: {
                      date: `ÂèëÁâàÊó∂Èó¥Ôºö${formattedDate}Ôºà‰ªäÂ§©Ôºâ`,
                      manager: `<at id=${currentUserId}></at>`,
                    },
                  },
                }),
              });

              await this.drizzle.db
                .update(dutiesTable)
                .set({
                  lastRunTime: format(new Date(), 'yyyy-MM-dd HH:mm:ss'),
                })
                .where(eq(dutiesTable.id, plan.id));
            } catch (error) {
              this.logger.error('ÊâßË°å‰ªªÂä°Â§±Ë¥•:', error);
            }
          })();
        };

      default:
        return () => {
          // Á©∫ÁöÑÂêåÊ≠•ÂáΩÊï∞ÔºåËøîÂõû void
        };
    }
  }

  /**
   * ÂàõÂª∫ËΩÆËΩ¨ÂÄºÁè≠‰∫∫ÂëòÁöÑÂõûË∞ÉÂáΩÊï∞
   */
  private createRotatorCallback(planId: number): () => void {
    return () => {
      void (async () => {
        const dutyInfo = await this.getDutyUserInfo(planId);
        const users = await this.drizzle.db
          .select()
          .from(dutiesUsers)
          .where(eq(dutiesUsers.dutyId, planId));

        await this.drizzle.db
          .update(dutiesTable)
          .set({
            personIndex: (dutyInfo.index + 1) % users.length,
          })
          .where(eq(dutiesTable.id, planId));
      })();
    };
  }

  /**
   * Ê∑ªÂä†ÂÆöÊó∂‰ªªÂä°
   * @param plan
   */
  addCronJob(plan: typeof dutiesTable.$inferSelect): void {
    try {
      const callback = this.createCallbackHandler(plan);
      this.taskCallbacks.set(plan.id, callback);

      // ÂàõÂª∫ÊâßË°åÊé®ÈÄÅ‰ªªÂä°ÁöÑ CronJob
      const executeTask = new CronJob(plan.cronSchedule, callback);

      // ÂàõÂª∫ËΩÆËΩ¨ÂÄºÁè≠‰∫∫ÂëòÁöÑ CronJob
      const dutyRotator = new CronJob(
        convertToCron(plan.dayOfWeek, plan.endTimeHour, plan.endTimeMinute),
        this.createRotatorCallback(plan.id),
      );

      // Âà†Èô§Â∑≤Â≠òÂú®ÁöÑ‰ªªÂä°
      if (this.scheduler.doesExist('cron', `${plan.id}-execute`)) {
        this.scheduler.deleteCronJob(`${plan.id}-execute`);
      }
      if (this.scheduler.doesExist('cron', `${plan.id}-rotator`)) {
        this.scheduler.deleteCronJob(`${plan.id}-rotator`);
      }

      // Ê∑ªÂä†Êñ∞‰ªªÂä°
      this.scheduler.addCronJob(`${plan.id}-execute`, executeTask);
      this.scheduler.addCronJob(`${plan.id}-rotator`, dutyRotator);

      // Ê£ÄÊü•ËÆ°ÂàíÊòØÂê¶ÂêØÁî®
      if (plan.enabled) {
        this.scheduler.getCronJob(`${plan.id}-execute`).start();
        this.scheduler.getCronJob(`${plan.id}-rotator`).start();
        this.logger.log(`Â∑≤Ê∑ªÂä†ÂÄºÁè≠ËÆ°Âàí: ${plan.name} ÁöÑÂÆöÊó∂‰ªªÂä°`);
      } else {
        this.logger.log(`${plan.name} ÁöÑÁä∂ÊÄÅ‰∏∫Á¶ÅÁî®ÔºåÂèñÊ∂àÂÆöÊó∂‰ªªÂä°`);
      }
    } catch (error: unknown) {
      if (error instanceof HttpException) {
        throw error;
      } else {
        throw new InternalServerErrorException(
          `Ê∑ªÂä†ÂÆöÊó∂‰ªªÂä°Â§±Ë¥•: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`,
        );
      }
    }
  }

  /**
   * Ê†πÊçÆÂÄºÁè≠ id Âà†Èô§ÂØπÂ∫îÂÆöÊó∂‰ªªÂä°Ôºà‰∏çÂà†Èô§Êï∞ÊçÆÂ∫ìËÆ∞ÂΩïÔºâ
   * @param planId ÂÄºÁè≠ËÆ°ÂàíID
   * @returns Âà†Èô§Êìç‰ΩúÁöÑÁªìÊûú‰ø°ÊÅØ
   */
  deleteCron(planId: number) {
    const jobs = [`${planId}-execute`, `${planId}-rotator`];

    // Âà†Èô§ÂõûË∞ÉÂáΩÊï∞
    this.taskCallbacks.delete(planId);

    // Âà†Èô§ÂÆöÊó∂‰ªªÂä°
    jobs.forEach((jobName) => {
      try {
        if (this.scheduler.doesExist('cron', jobName)) {
          this.scheduler.deleteCronJob(jobName);
          this.logger.log(`Â∑≤Âà†Èô§ÂÆöÊó∂‰ªªÂä°: ${jobName}`);
        }
      } catch (error) {
        throw new InternalServerErrorException(
          `Âà†Èô§ÂÆöÊó∂‰ªªÂä° ${jobName} Êó∂Âá∫Áé∞ÈîôËØØ: ${error}`,
        );
      }
    });
  }

  /**
   * Ê†πÊçÆÂÄºÁè≠ id Êõ¥Êñ∞ÂØπÂ∫îÂÆöÊó∂‰ªªÂä°
   * @param planId ÂÄºÁè≠ËÆ°ÂàíID
   */
  async updateCron(planId: number): Promise<void> {
    // ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂÄºÁè≠ËÆ°Âàí
    const plans = await this.drizzle.db
      .select()
      .from(dutiesTable)
      .where(eq(dutiesTable.id, planId));

    if (plans.length > 0) {
      this.addCronJob(plans[0]);
    } else {
      throw new NotFoundException(`Êú™ÊâæÂà∞ID‰∏∫ ${planId} ÁöÑÂÄºÁè≠ËÆ°Âàí`);
    }
  }

  /**
   * Ê†πÊçÆÂÄºÁè≠ id ÊâãÂä®ËøêË°åÂØπÂ∫îÂÆöÊó∂‰ªªÂä°
   * @param planId
   */
  manualRun(planId: number): { success: boolean; message: string } {
    const callback = this.taskCallbacks.get(planId);

    if (!callback) {
      throw new InternalServerErrorException(
        `Êú™ÊâæÂà∞ID‰∏∫ ${planId} ÁöÑ‰ªªÂä°Êàñ‰ªªÂä°Êú™ÂàùÂßãÂåñ`,
      );
    }

    // ÊâßË°åÂõûË∞ÉÂáΩÊï∞ÔºàÂõûË∞ÉÂáΩÊï∞ÂÜÖÈÉ®‰ºöÂ§ÑÁêÜÊõ¥Êñ∞ÊúÄÂêéËøêË°åÊó∂Èó¥ÁöÑÈÄªËæëÔºâ
    callback();
    return {
      success: true,
      message: `ID‰∏∫ ${planId} ÁöÑ‰ªªÂä°Â∑≤ÊàêÂäüÊâãÂä®ÊâßË°å`,
    };
  }

  async onModuleInit() {
    try {
      const plans = await this.drizzle.db.select().from(dutiesTable);
      for (const plan of plans) {
        this.addCronJob(plan);
      }
    } catch (error) {
      this.logger.error('ÂàùÂßãÂåñÂÆöÊó∂‰ªªÂä°Â§±Ë¥•:', error);
    }
  }
}
